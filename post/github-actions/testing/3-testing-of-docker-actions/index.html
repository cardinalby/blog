<!doctype html><html prefix="og: http://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Testing of Docker Actions &#183; cardinalby</title><meta name=description content="In this part I&rsquo;m going to tell about approaches that can be used to test a Docker container Action.
Unit tests An approach here depends on what programming language you use inside a container. Each of them has own testing libraries that can be used to test an application in the container.
If you use bare bash script, you can divide a single entrypoint.sh file into the several small scripts considering them as units and testing separately."><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=generator content="Hugo 0.101.0"><meta name=robots content="index,follow"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Testing of Docker Actions"><meta property="og:description" content="In this part I&rsquo;m going to tell about approaches that can be used to test a Docker container Action.
Unit tests An approach here depends on what programming language you use inside a container. Each of them has own testing libraries that can be used to test an application in the container.
If you use bare bash script, you can divide a single entrypoint.sh file into the several small scripts considering them as units and testing separately."><meta property="og:type" content="article"><meta property="og:url" content="https://cardinalby.github.io/blog/post/github-actions/testing/3-testing-of-docker-actions/"><link rel=stylesheet href=https://cardinalby.github.io/blog/dist/site.css><link rel=stylesheet href=https://cardinalby.github.io/blog/dist/syntax.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><base href=https://cardinalby.github.io/blog/><link rel="shortcut icon" type=image/jpg href=favicon.png><link rel=stylesheet href=css/custom.css></head><body><script async src="https://www.googletagmanager.com/gtag/js?id=G-S1HYRNQV86"></script>
<script>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-S1HYRNQV86",{anonymize_ip:!0})}</script><div id=wrapper><header class=site-header><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://cardinalby.github.io/blog/>Tech grumbling</a></h1><a class=button-square href=https://cardinalby.github.io/blog/index.xml aria-label=RSS><i class="fa fa-rss" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=Github aria-label=Github href=https://github.com/cardinalby rel=me><i class="fa fa-github-alt" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint="Stack Overflow" aria-label="Stack Overflow" href=https://stackoverflow.com/users/1180397/cardinal rel=me><i class="fa fa-stack-overflow" aria-hidden=true></i></a>
<a class="button-square button-social hint--top" data-hint=LinkedIn aria-label=LinkedIn href=https://www.linkedin.com/in/sergey-borodin/ rel=me><i class="fa fa-linkedin" aria-hidden=true></i></a></div><ul class=site-nav><li class=site-nav-item><a href=/blog/>Blog</a></li><li class=site-nav-item><a href=/blog/project/>Projects</a></li><li class=site-nav-item><a href=/blog/tags/>Tags</a></li><li class=site-nav-item><a href=/blog/page/about/>About</a></li></ul></div></header><div id=container><div class=container><article class=post-container itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Testing of Docker Actions</h1><p class=post-date><span>Published <time datetime=2021-12-03 itemprop=datePublished>Dec 3, 2021</time></span>
<span>by</span>
<span itemscope itemprop=author itemtype=https://schema.org/Person><span itemprop=name><a href=https://github.com/cardinalby itemprop=url rel=author>cardinalby</a></span></span></p><p class="post-reading post-line"><span>Estimated reading time: 4 min</span></p></header><div class="post-content clearfix" itemprop=articleBody><img class=post-featured-image src=images/posts/github-actions/testing/title.png><div class=series-parts-block><div class=series-parts-title><div class=series-label>SERIES</div><div class=series-name><a href=/blog/series/testing-of-github-actions>Testing of GitHub Actions</a></div></div><div class=series-part><span class=circled-number>1</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/1-testing-of-github-actions-intro/>Testing of GitHub Actions. Intro</a></div><div class=series-part><span class=circled-number>2</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/2-testing-of-js-actions/>Testing of JavaScript Actions</a></div><div class="series-part current"><span class=circled-number>3</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/3-testing-of-docker-actions/>Testing of Docker Actions</a></div><div class=series-part><span class=circled-number>4</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/4-system-testing-of-github-actions/>System testing of GitHub Actions</a></div></div><h3 class=series-part-block-print-only>Post <b>3</b> of <b>4</b> in "Testing of GitHub Actions" series</h3><p>In this part I&rsquo;m going to tell about approaches that can be used to test a Docker container Action.</p><h1 id=unit-tests>Unit tests</h1><p>An approach here depends on what programming language you use inside a container. Each of them has own testing libraries that can be used to test an application in the container.</p><p>If you use bare bash script, you can divide a single <em>entrypoint.sh</em> file into the several small scripts considering them as units and testing separately.</p><p>The following approaches can be used to isolate their effects:</p><ul><li>Redirecting scripts output to a temporary file.</li><li>Interacting with the main script through environment variables.</li><li>Don&rsquo;t hardcode path of filesystem that is modified by scripts, use env variables for that. It will allow you to use temp directories and files during testing.</li></ul><p>Take a look at
<a href=https://thorsteinssonh.github.io/bash_test_tools/ target=_blank>bash_test_tools</a> - it&rsquo;s an analog of JavaScript test frameworks for bash scripts and executables.</p><p>It&rsquo;s better to use an environment similar to the production one in tests. Thankfully, it&rsquo;s not a problem with Docker containers. Just create a separate <em>Dockerfile</em> that runs tests in the same environment that the main <em>Dockerfile</em> defines.</p><h1 id=integration-tests>Integration tests</h1><p><em>github-action-ts-run-api</em>
<a href=https://github.com/cardinalby/github-action-ts-run-api/blob/master/docs/run-targets.md#docker-target target=_blank>can run</a> Docker actions locally on Linux with native Docker, on MacOS and Windows via Docker Desktop and on any CI where Docker is installed (only Linux GitHub-hosted runners have docker support at the moment).</p><p>You still have the same TypeScript API for running, preparing all inputs, environment and examining results of an action execution.</p><p>Actually, it looks more like a system test (because action is black-boxed and executed as a whole) run using TypeScript API instead of normal yml workflow syntax. If you want to perform an integration test of only of some part of your code, probably, you need to create a separate Dockerfile and use <em>github-action-ts-run-api</em> to run it.</p><p>Working with a file system in a Docker action follows the common principle: don&rsquo;t use hardcoded paths, rely on
<a href=https://github.com/cardinalby/github-action-ts-run-api/blob/master/docs/run-targets/docker.md#paths-in-container target=_blank>the environment variables</a> provided by GitHub instead.</p><p><em>github-action-ts-run-api</em> allows you to prepare contents of all these dirs and files before the tested action run and examine their contents after it has finished.
<a href=https://github.com/cardinalby/github-action-ts-run-api/blob/master/docs/run-options.md#-setfakefsoptions target=_blank>By default</a>, temporary directories and files are created and attached as volumes to the tested action container.Corresponding environment variables are set to point to the mounting points of these volumes.</p><h1 id=stubbing-external-services>Stubbing external services</h1><p>Advice here is similar to the one given for JavaScript actions. Don&rsquo;t hardcode URLs of external services in your code:</p><ul><li>For GitHub API use the dedicated <code>GITHUB_API_URL</code>, <code>GITHUB_SERVER_URL</code>, <code>GITHUB_GRAPHQL_URL</code>
<a href=https://docs.github.com/en/actions/learn-github-actions/environment-variables target=_blank>environment variables</a>.</li><li>For other external services introduce custom env variables that can be set in tests. In they are empty action just uses real production URLs.</li></ul><h2 id=nodejs-server>NodeJS server</h2><p>As in the case of JavaScript actions testing you can easily create a stub HTTP server right in the test suite managed by NodeJS and pass a base URL of the created stub server through environment variables to the tested action.</p><p>In this case the base URL of stub server should be:</p><ul><li><code>host.docker.internal</code> for Docker Desktop</li><li><code>172.17.0.1</code> for native Linux Docker</li></ul><p>Check out
<a href=https://github.com/cardinalby/github-action-ts-run-api/blob/master/docs/run-targets/docker.md#-stubbing-github-api-by-local-nodejs-http-server target=_blank>the example</a>.</p><h2 id=docker-container-server>Docker container server</h2><p>Since we test a docker container action it would be natural to spin up a stub HTTP server in a docker container that will run along with the tested docker action container.</p><p>The best way of doing it is to create a <code>docker-compose.yml</code> file that defines a service with the stub HTTP server and a named network:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fake-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Image with stub GitHub API HTTP server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>httpServerDir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;80:80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Assign a name to the network to connect </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># the tested action container to it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testNet</span><span class=w>
</span></span></span></code></pre></div><ol><li>Execute <code>docker compose up</code> before testing the action container.</li><li>Attach the action container to the named network (<code>testNet</code> in the example) and pass a base URL of the created stub server through environment variables to the tested action (<code>fake-server</code> in the example).</li><li>Execute <code>docker compose down</code> after the action container finished.</li></ol><p>There is convenient
<a href=https://github.com/cardinalby/github-action-ts-run-api/blob/master/src/actionRunner/docker/utils/withDockerCompose.ts target=_blank><code>withDockerCompose()</code></a> utility function in <em>github-action-ts-run-api</em> package for performing these steps:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-typescript data-lang=typescript><span class=line><span class=cl><span class=k>await</span> <span class=nx>withDockerCompose</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;path/to/docker-compose.yml&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>target</span> <span class=o>=</span> <span class=nx>RunTarget</span><span class=p>.</span><span class=nx>dockerAction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;path/to/action.yml&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// network name defined in docker-compose.yml    
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span><span class=nx>network</span><span class=o>:</span> <span class=s1>&#39;testNet&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>target</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=nx>RunOptions</span><span class=p>.</span><span class=nx>create</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1>// service name defined in docker-compose.yml
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>.</span><span class=nx>setGithubContext</span><span class=p>({</span><span class=nx>apiUrl</span><span class=o>:</span> <span class=sb>`http://fake-server:80`</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>assert</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>commands</span><span class=p>.</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>out1</span> <span class=o>===</span> <span class=s1>&#39;fake_response&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span></code></pre></div><p>Check out
<a href=https://github.com/cardinalby/github-action-ts-run-api/blob/master/docs/run-targets/docker.md#-stubbing-github-api-by-http-server-container target=_blank>the example</a>.</p><h1 id=remarks>Remarks</h1><p>ðŸ”» Docker Desktop for Windows and MacOS behaves differently from native docker on Linux. Be aware!</p><div class=series-parts-block><div class=series-parts-title><div class=series-label>SERIES</div><div class=series-name><a href=/blog/series/testing-of-github-actions>Testing of GitHub Actions</a></div></div><div class=series-part><span class=circled-number>1</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/1-testing-of-github-actions-intro/>Testing of GitHub Actions. Intro</a></div><div class=series-part><span class=circled-number>2</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/2-testing-of-js-actions/>Testing of JavaScript Actions</a></div><div class="series-part current"><span class=circled-number>3</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/3-testing-of-docker-actions/>Testing of Docker Actions</a></div><div class=series-part><span class=circled-number>4</span>
<a href=https://cardinalby.github.io/blog/post/github-actions/testing/4-system-testing-of-github-actions/>System testing of GitHub Actions</a></div></div><h3 class=series-part-block-print-only>Post <b>3</b> of <b>4</b> in "Testing of GitHub Actions" series</h3></div><footer class="post-footer clearfix"><p class=post-tags><span>Tagged:</span>
<a href=/tags/github-actions/>github-actions</a>,
<a href=/tags/docker/>docker</a>,
<a href=/tags/testing/>testing</a></p><div class=share></div></footer><div class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-cardinalby-github-io-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></div></div><footer class=footer><div class=container><div class=site-title-wrapper><h1 class=site-title><a href=https://cardinalby.github.io/blog/>Tech grumbling</a></h1><a class="button-square button-jump-top js-jump-top" href=# aria-label="Back to Top"><i class="fa fa-angle-up" aria-hidden=true></i></a></div><p class=footer-copyright><span>&copy; 2022 / Powered by <a href=https://gohugo.io/>Hugo</a></span></p></div></footer><script src=https://cardinalby.github.io/blog/js/jquery-1.11.3.min.js></script>
<script src=https://cardinalby.github.io/blog/js/jquery.fitvids.js></script>
<script src=https://cardinalby.github.io/blog/js/scripts.js></script>
<script src=js/copy-code-to-clipboard.js></script></body></html>